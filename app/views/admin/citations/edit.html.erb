<%= content_for :main_wrapper_class, "container-padded" %>
<% ratings = @citation.ratings %>

<div class="large-width-container">
  <h1 class="standard-top-offset mb-4">Edit Citation</h1>
  <p class="mb-3">
    Missing metadata: <%= missing_meta_count(@citation) %>
    <% missing_meta = @citation.missing_meta_attrs %>
    <% if missing_meta.count > 0 && missing_meta.count < Citation::COUNTED_META_ATTRS.count %>
      <small class="less-strong">(<%= @citation.missing_meta_attrs.join(", ") %>)</small class="text-sm">
    <% end %>
  </p>
  <%= form_with(model: @citation, url: admin_citation_url(@citation), method: :patch, class: "pb-2") do |f| %>
    <%= render partial: "/shared/errors", locals: {obj: @citation, name: "Citation"} %>
    <div class="row sm:grid-cols-2">
      <div class="col">
        <div class="form-row">
          <%= f.label :title %>
          <%= f.text_field :title, class: "form-control", required: true %>
        </div>
      </div>
      <div class="col">
        <div class="form-row">
          <%= f.label :url %>
          <%= f.text_field :url, class: "form-control", disabled: true %>
        </div>
      </div>
    </div>
    <div class="form-row">
      <%= f.label :topics_string do %>
        Topics
        <small class="less-strong">Comma delineated</small>
      <% end %>
      <%= f.text_field :topics_string, class: "form-control" %>
    </div>
    <div class="form-row-btn">
      <%= f.submit "save", class: "btn" %>
    </div>
    <div class="row sm:grid-cols-2">
      <div class="col">
        <div class="form-row">
          <%= f.label :authors_str do %>
            Authors
            <small class="less-strong">new line delineated</small>
          <% end %>
          <%= f.text_area :authors_str, class: "form-control" %>
        </div>
      </div>
      <div class="col">
        <div class="form-row">
          <%= f.label :description %>
          <%= f.text_area :description, class: "form-control" %>
        </div>
      </div>
    </div>
    <div class="row sm:grid-cols-2">
      <div class="col">
        <div class="form-row">
          <%= f.label :published_at %>
          <%= f.datetime_local_field :published_at, class: "form-control" %>
        </div>
      </div>
      <div class="col">
        <div class="form-row">
          <%= f.label :published_updated_at %>
          <%= f.datetime_local_field :published_updated_at, class: "form-control" %>
        </div>
      </div>
    </div>
    <div class="row sm:grid-cols-2">
      <div class="col">
        <div class="form-row">
          <%= f.label :word_count %>
          <%= f.number_field :word_count, class: "form-control" %>
        </div>
      </div>
      <div class="col">
        <div class="form-row">
          <%= f.label :canonical_url %>
          <%= f.text_field :canonical_url, class: "form-control" %>
        </div>
      </div>
      <div class="col">
        <div class="form-row">
          <%= f.label :paywall, class: "form-control-check" do %>
            <%= f.check_box :paywall %>
            Has a paywall
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <h2 class="standard-top-offset mb-2">
    <%= admin_number_display(ratings.count) %>
    <%= "Rating".pluralize(ratings.count) %>
    <% if ratings.count > 10 %>
      <small>first 10 shown, <%= link_to "see all", admin_ratings_path(search_citation_id: @citation.id) %></small>
    <% end %>
    <%= button_to "reprocess ratings", admin_citation_path(@citation.to_param, update_citation_metadata_from_ratings: true), method: :patch, class: "link text-sm text-primary" %>
  </h2>
</div>

<%= render partial: "/admin/ratings/table", locals: {ratings: ratings.limit(10), skip_sortable: true} %>

<% ratings_ordered = UpdateCitationMetadataFromRatingsJob.ordered_ratings(@citation) %>
<% if ratings_ordered.count > 10 %>
  <h3></h3>
<% end %>
<div class="large-width-container mb-6">
  <div class="row sm:grid-cols-2">
    <% ratings.each do |rating| %>
      <div class="col mt-4 mr-2 py-2 border-gray-200 border">
        <p>
          <%= link_to l(rating.created_at, format: :convert_time), admin_rating_path(rating), class: "convertTime" %>
          by: <%= rating.user&.username %>

        </p>
        <div class="code-small">
          <%# skipping canonical_url for now, because it's just noise %>
          <%= pretty_print_json(rating.metadata_attributes.except(:canonical_url)) %>
        </div>
      </div>
    <% end %>
  </div>
</div>
