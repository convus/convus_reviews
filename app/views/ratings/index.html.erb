<%= content_for :main_wrapper_class, "container-padded" %>
<div class="large-width-container">
  <% search_params_present = (params.keys - %w[user controller action]).any? %>
  <% if @viewing_single_user %>
    <% unless search_params_present %>
      <%= render partial: "/u/user_display", locals: {user: user_subject, render_second_hr: true, only_render_name: search_params_present} %>
    <% end %>
    <div class="mb-4">
      <h1>Ratings by <%= user_subject.username %></h1>
      <% if @ratings_private %>
        <h2 class="mt-4">
          Ratings are private
          <% if @can_view_ratings %>
            <small class="less-strong">
              (they're visible because
              <% if @viewing_current_user %>it's your account<% else %>you follow them<% end %>)
            </small>
          <% end %>
        </h2>
      <% end %>
    </div>
  <% elsif viewing_display_name == "following" %>
    <h1 class="mt-4 mb-4">Ratings by people you <%= link_to "follow", following_u_path(id: current_user.to_param) %></h1>
  <% else %>
    <h1 class="mt-4">
      Recent ratings
    </h1>
  <% end %>
</div>
<% if @can_view_ratings %>
  <% if @ratings.total_count == 0 %>
    <div class="large-width-container">
      <% if viewing_display_name == "following" %>
        <h4 class="standard-top-offset">No one you follow has visible ratings</h4>
      <% else %>
        <h4 class="standard-top-offset"><%= user_subject.username %> has no ratings</h4>
      <% end %>
    </div>
  <% else %>
    <div class="large-width-container">
      <% if viewing_display_name == "recent" %>
        <p class="less-strong mb-4"><em>See ratings by <%= link_to "people you're following", ratings_path(user: "following") %></em></p>
      <% end %>
      <%= render partial: "/shared/current_header", locals: {viewing: "Ratings", collection: @ratings} %>
    </div>
    <% if @assign_topic.present? %>
      <%# duplicating this whole thing is gross, but... HACK HACK HACK %>
      <%= form_tag add_topic_ratings_path(sortable_search_params), method: :post, class: "" do %>
        <%= hidden_field_tag :included_ratings, @ratings.pluck(:id).join(",") %>
        <p class="large-width-container mb-3">
          <%= button_tag type: "submit", class: "btn btn-success" do %>
            Mark checked ratings applicable to <%= topic_review_display(@assign_topic, "ml-1") %>
          <% end %>
        </p>
        <%= render partial: "table", locals: {ratings: @ratings, edit_ratings: user_subject == current_user, render_user: !@viewing_single_user, hide_private_users: @viewing_display_name == "recent", render_assign_topic: @assign_topic} %>
      <% end %>
    <% else %>
      <%# duplicating this whole thing is gross %>
      <%= render partial: "table", locals: {ratings: @ratings, edit_ratings: user_subject == current_user, render_user: !@viewing_single_user, hide_private_users: @viewing_display_name == "recent"} %>
    <% end %>
    <div class="large-width-container">
      <div class="row">
        <%= render partial: "tranzito_utils/pagination", locals: {collection: @ratings, name: "Rating", skip_total: true} %>
      </div>
    </div>
  <% end %>
<% end %>
